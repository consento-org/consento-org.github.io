(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{92:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return i})),a.d(t,"metadata",(function(){return r})),a.d(t,"toc",(function(){return s})),a.d(t,"default",(function(){return h}));var n=a(3),c=a(7),o=(a(0),a(121)),i={title:"Timestamp synchronization",section:"blocks",license:"CC-BY",author:"martin",year:2021},r={type:"mdx",permalink:"/blocks/time",source:"@site/src/pages/blocks/time.md"},s=[{value:"Background",id:"background",children:[]},{value:"Why not trusted timestamps?",id:"why-not-trusted-timestamps",children:[]},{value:"Enter Hybrid Logical Clocks",id:"enter-hybrid-logical-clocks",children:[]},{value:"Implementation",id:"implementation",children:[]}],l={toc:s};function h(e){var t=e.components,a=Object(c.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"[State: done]"," \u2192 ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/consento-org/hlc"}),"consento-org/hlc")),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},Object(o.b)("strong",{parentName:"p"},"TLDR;")," The local time of devices is not 100% in sync. Using timeservers requires a working internet connection and becomes a point of centralization. Vector clocks dont store a human readable time. The hybrid logical clock allows to have sorted, human readable time stamps for that are practically in-sync.")),Object(o.b)("h2",{id:"background"},"Background"),Object(o.b)("p",null,"We need to have timestamps for any operation done with consento. These timestamps are relevant for log auditing and to make sure that operations done on two devices get processed in the correct order on sync."),Object(o.b)("p",null,"The timestamps on devices can be changed and out-of-sync and as such are not reliable. Which is why we had to explore other solutions for this."),Object(o.b)("h2",{id:"why-not-trusted-timestamps"},"Why not trusted timestamps?"),Object(o.b)("p",null,"Trusted timestamps, as described in ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.ietf.org/rfc/rfc3161.txt"}),"RFC3161"),", work well to make sure that entries are signed at a certain timestamp; but those take time to compute, require a persistent internet connection, and an outside service and what is more: an authority trusted by all parties involved to sign those entries."),Object(o.b)("h2",{id:"enter-hybrid-logical-clocks"},"Enter Hybrid Logical Clocks"),Object(o.b)("p",null,"A hybrid logical clock (hlc) is a clock based on the devices clock. If no sync happens it will always just use the local device time."),Object(o.b)("p",null,"What makes it different from the device clock is that it will change the internal behavior if it encounters a timestamp created by another device that is in the future."),Object(o.b)("p",null,"In this case, the hlc will use the latest received timestamp and start a logical counter that increments every time a new timestamp is requested."),Object(o.b)("p",null,"(thanks ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/urbien"}),"Gene")," who highlighed the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"http://muratbuffalo.blogspot.com/2014/07/hybrid-logical-clocks.html"}),"hybrid logical clock")," and their use of it in ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/tradle/multi-hyperbee"}),"multi-hyperbee"),")"),Object(o.b)("h2",{id:"implementation"},"Implementation"),Object(o.b)("p",null,Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.cockroachlabs.com/"}),"CockroachDB")," has a quite ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/cockroachdb/cockroach/blob/663fcf17cb8789a2c46a719e0107a15400eee918/pkg/util/hlc/hlc.go"}),"strong implementation")," of a hlc in go-lang but we needed a JavaScript variant, working within the hypercore ecosystem."),Object(o.b)("p",null,"To make sure that there is the lowest possible chance of equal timestamps, we have created ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/consento-org/bigint-time"}),"bigint-time")," which will return the current time in nanoseconds."),Object(o.b)("p",null,"And we published ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/consento-org/hlc"}),"@consento/hlc")," that basically functions as the example below and can be reused for any sort of timestamp-syncing mechanism."),Object(o.b)("p",null,Object(o.b)("em",{parentName:"p"},"(Note: the configuration is rather complex, please refer to the documenation!)")),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"const HLC = require('@consento/hlc')\nconst hlc = new HLC()\n\n// Every new timestamp is used to make sure that the\n// local clock\n// is always ahead of previous timestamps.\nfunction onNewTimestamp (otherDeviceTimestamp) {\n  hlc.update(otherDeviceTimestamp)\n}\n\nconst list = []\nlist.push(hlc.now())\n")))}h.isMDXComponent=!0}}]);